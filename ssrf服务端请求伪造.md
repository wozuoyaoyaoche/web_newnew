#  ssrf简介

服务器端有一个内网体系,其中有暴露在公网的一个主机,可以利用这台主机访问其他内网应用

SSRF漏洞可以利用存在缺陷的WEB应用作为代理攻击远程和本地的服务器

## 漏洞一般存在地方

当服务器需要调用其他主机上的资源的时候

例如:

```
社交分享功能：获取超链接的标题等内容进行显示
转码服务：通过URL地址把原地址的网页内容调优使其适合手机屏幕浏览
在线翻译：给网址翻译对应网页的内容
图片加载/下载：例如富文本编辑器中的点击下载图片到本地、通过URL地址加载或下载图片
图片/文章收藏功能：主要其会取URL地址中title以及文本的内容作为显示以求一个好的用具体验
云服务厂商：它会远程执行一些命令来判断网站是否存活等，所以如果可以捕获相应的信息，就可以进行ssrf测试
网站采集，网站抓取的地方：一些网站会针对你输入的url进行一些信息采集工作
数据库内置功能：数据库的比如mongodb的copyDatabase函数
邮件系统：比如接收邮件服务器地址
编码处理、属性信息处理，文件处理：比如ffpmg，ImageMagick，docx，pdf，xml处理器等
未公开的api实现以及其他扩展调用URL的功能：可以利用google语法加上这些关键字去寻找SSRF漏洞。一些的url中的关键字有：share、wap、url、link、src、source、target、u、3g、display、sourceURl、imageURL、domain……
从远程服务器请求资源
```

## ssrf用途

```
内外网的端口和服务扫描
主机本地敏感数据的读取
内外网主机应用程序漏洞的利用
内外网web站点漏洞的利用
```

# ssrf利用方式

### http/https协议

当前应用获取用户传递过来的url参数后端发送请求，并且将最终的请求结果返回到html前端页面。

```
http://192.168.11.135/ssrf.php?url=http://www.baidu.com
http://192.168.11.135/ssrf.php?url=https://www.baidu.com
```

但这里需要注意的一点是，当前网站页面返回的内容并非是从当前用户`pc`端浏览器发送的，而是，服务器端接收到客户端传递过来的`url`参数，然后在后端服务器代码中通过构造请求发送，最终将结果返回到前端



### file协议

如果服务器端对请求资源所使用的协议方式没有进行限制，那么就可以通过file协议访问当前服务器的本地文件

```
http://192.168.11.135/ssrf.php?url=file:///etc/passwd
```



### dict协议

通过`dict` 协议可以远程访问一个指定的tcp 端口，并且会返回端口所提供的服务的部分组件信息

当目标端口开放（有服务信息显示，但会报错）：

```
http://192.168.11.135/ssrf.php?url=dict://localhost:80
```

当目标端口关闭:无任何显示

通过差异的对比，可确认内网端口开放情况。

```
思考：实际干活时，ssrf漏洞该怎么利用来探测内网网段、开放端口及端口服务？
一般开放的ip地址就是192.168.0.0/16 10.0.0.0/8 172.16.0.0/16 常见端口可能是80,22,254等,排列组合尝试
```

# 防御方式

```
禁用不需要的协议(如：file:///、gopher://,dict://等)，仅仅允许http和https请求
统一错误信息，防止根据错误信息判断端口状态
禁止302跳转，或每次跳转，都检查新的Host是否是内网IP，直到抵达最后的网址
设置URL白名单或者限制内网IP
```
